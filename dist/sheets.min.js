var sheets=function(t){var e={};function s(i){if(e[i])return e[i].exports;var h=e[i]={i:i,l:!1,exports:{}};return t[i].call(h.exports,h,h.exports,s),h.l=!0,h.exports}return s.m=t,s.c=e,s.d=function(t,e,i){s.o(t,e)||Object.defineProperty(t,e,{enumerable:!0,get:i})},s.r=function(t){"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(t,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(t,"__esModule",{value:!0})},s.t=function(t,e){if(1&e&&(t=s(t)),8&e)return t;if(4&e&&"object"==typeof t&&t&&t.__esModule)return t;var i=Object.create(null);if(s.r(i),Object.defineProperty(i,"default",{enumerable:!0,value:t}),2&e&&"string"!=typeof t)for(var h in t)s.d(i,h,function(e){return t[e]}.bind(null,h));return i},s.n=function(t){var e=t&&t.__esModule?function(){return t.default}:function(){return t};return s.d(e,"a",e),e},s.o=function(t,e){return Object.prototype.hasOwnProperty.call(t,e)},s.p="",s(s.s=0)}([function(t,e,s){"use strict";s.r(e);var i=class{constructor(t,e){e=Object.assign({onMouseMove:(t,e)=>{},onMouseDown:(t,e)=>{},onMouseUp:(t,e)=>{},onMouseClick:(t,e)=>{},onScroll:(t,e)=>{}},e),t.width=2*e.width,t.height=2*e.height,t.style.width=e.width+"px",t.style.height=e.height+"px",this.ctx=t.getContext("2d"),this.ctx.scale(2,2);var s=this;const i=function(t){var e=s.ctx.canvas.getBoundingClientRect();return{x:t.clientX-e.left,y:t.clientY-e.top}};this.ctx.canvas.onmousemove=function(t){var s=i(t);e.onMouseMove(s.x,s.y),t.preventDefault()},this.ctx.canvas.onmousedown=function(t){var s=i(t);e.onMouseDown(s.x,s.y),t.preventDefault()},this.ctx.canvas.onmouseup=function(t){var s=i(t);e.onMouseUp(s.x,s.y),t.preventDefault()},this.ctx.canvas.onclick=function(t){var s=i(t);e.onMouseClick(s.x,s.y),t.preventDefault()},this.ctx.canvas.onmousewheel=function(t){e.onScroll(t.deltaX,t.deltaY),t.preventDefault()}}drawLine(t,e){e=Object.assign({width:1,color:"black",cap:"square",lineJoin:"miter"},e),this.ctx.beginPath(),this.ctx.moveTo(t[0][0],t[0][1]);for(let e=1;e<t.length;e++)this.ctx.lineTo(t[e][0],t[e][1]);this.ctx.lineWidth=e.width,this.ctx.strokeStyle=e.color,this.ctx.lineCap=e.cap,this.ctx.lineJoin=e.lineJoin,this.ctx.stroke()}drawRect(t,e,s,i,h){h=Object.assign({borderWidth:1,borderColor:void 0,fillColor:void 0},h),this.ctx.beginPath(),h.fillColor&&(this.ctx.fillStyle=h.fillColor),h.borderColor&&(this.ctx.lineWidth=h.borderWidth,this.ctx.strokeStyle=h.borderColor),this.ctx.rect(t,e,s,i),h.fillColor&&this.ctx.fill(),h.borderColor&&this.ctx.stroke()}drawText(t,e,s,i){i=Object.assign({font:"14px Sans",color:"white",align:"center",baseLine:"middle"},i),this.ctx.font=i.font,this.ctx.fillStyle=i.color,this.ctx.textAlign=i.align,this.ctx.textBaseline=i.baseLine,this.ctx.fillText(t,e,s)}drawImage(t,e,s,i,h){this.ctx.drawImage(t,e,s,i,h)}clear(){this.ctx.clearRect(0,0,this.ctx.canvas.width,this.ctx.canvas.height)}};var h=class{constructor(t,e,s,i,h){this.sheet=t,this.x=e,this.y=s,this.width=i,this.height=h}draw(){}isVisibleOnScreen(){return!(this.x+this.sheet.scrollX+this.width<0||this.x+this.sheet.scrollX>this.sheet.width||this.y+this.sheet.scrollY+this.height<0||this.y+this.sheet.scrollY>this.sheet.height)}isCollision(t,e){return t>this.x+this.sheet.scrollX&&t<this.x+this.sheet.scrollX+this.width&&e>this.y+this.sheet.scrollY&&e<this.y+this.sheet.scrollY+this.height}};var l=class extends h{constructor(t,e,s,i,h,l,o,r){super(s,i,h,l,o,r),this.rowIndex=e,Object.assign(this,{color:"black",backGroundColor:"lightGray",borderColor:"darkGray",borderWidth:1},r),this.textBufferCanvas=document.createElement("canvas"),this.textBufferContext=this.textBufferCanvas.getContext("2d"),this.textBufferCanvas.width=2*this.width,this.textBufferCanvas.height=2*this.height,this.textBufferCanvas.style.width=this.width,this.textBufferCanvas.style.height=this.height,this.textBufferContext.scale(2,2),this.textBufferContext.font=.8*this.height+"px Sans",this.textBufferContext.fillStyle=this.color,this.textBufferContext.textAlign="center",this.textBufferContext.textBaseline="middle",this.updateText(e+1)}updateText(t){this.text=t,this.textBufferContext.fillText(this.text,this.width/2,this.height/2)}draw(){this.sheet.context.drawRect(this.x,this.sheet.scrollY+this.y,this.width,this.height,{fillColor:this.backGroundColor,borderColor:this.borderColor,borderWidth:this.borderWidth}),this.sheet.context.drawImage(this.textBufferCanvas,this.x,this.y+this.sheet.scrollY,this.width,this.height)}};const o=40,r=70,n=20,c="ABCDEFGHIJKLMNOPQRSTUVWXYZ",d=t=>{let e=t,s="";for(;e>-1;){s=c[e%26]+""+s,e=Math.floor(e/26)-1}return s},a=t=>{let e=(c.indexOf(t[0])+1)*Math.pow(26,t.length-1)-1;for(let s=t.length-1;s>0;s--)e+=(c.indexOf(t[s])+1)*Math.pow(26,t.length-s-1);return e};var u=class extends h{constructor(t,e,s,i,h,l,o,r){super(s,i,h,l,o),this.index=t,this.rowIndex=e,this.text="",Object.assign(this,{color:"black",backGroundColor:"white",borderColor:"darkGray",borderWidth:1},r),this.dependentCells=[]}registerDependentValueCell(t){this.dependentCells.push(t)}updateValue(t){if(this.value=t,void 0===t||null===t)return;const e=t=>{if(/[A-Z]+/.test(t)){let e=colAlphaMatch[0],s=a(e),i=t.match(/\d+/)[0]-1;return this.sheet.getCell(i,s).value}return t};if(0==t.indexOf("=")){let s=t.substr(1).split("(")[0],i=t.substr(1).split("(")[1].replace(")","").split(","),h=[];for(let t=0;t<i.length;t++){let s=i[t].trim();if(-1!==s.indexOf(":")){let t=s.split(":");for(let s=0;s<t.length;s++)h.push(e(t[s]))}else h.push(e(s))}let l=formulajs[s].apply(null,h);this.text=l}else this.text=t;this.isTextBufferInitialized||(this.textBufferCanvas=document.createElement("canvas"),this.textBufferContext=new i(this.textBufferCanvas,{width:this.width,height:this.height}),this.isTextBufferInitialized=!0),this.isNumeric=this.text&&/^\d*(\.\d+)?$/.test(this.text),this.repaint()}repaint(){this.isTextBufferInitialized&&(this.textBufferContext=new i(this.textBufferCanvas,{width:this.width,height:this.height}),this.textBufferContext.clear(),this.textBufferContext.drawRect(0,0,this.width,this.height,{fillColor:this.isSelected?"#c9e2f9":this.backGroundColor,borderColor:this.borderColor,borderWidth:this.borderWidth}),this.textBufferContext.drawText(this.text,this.isNumeric?this.width:0,this.height/2,{font:.8*this.height+"px Sans",color:this.color,align:this.isNumeric?"end":"start",baseLine:"middle"})),this.isEditing&&(this.width>4?this.inputElement.width(this.width-4):this.blur())}draw(){this.isTextBufferInitialized?this.sheet.context.drawImage(this.textBufferCanvas,this.x+this.sheet.scrollX,this.y+this.sheet.scrollY,this.width,this.height):this.sheet.context.drawRect(this.sheet.scrollX+this.x,this.sheet.scrollY+this.y,this.width,this.height,{fillColor:this.isSelected?"#c9e2f9":this.backGroundColor,borderColor:this.borderColor,borderWidth:this.borderWidth}),this.isEditing&&(this.sheet.scrollX+this.x<o||this.sheet.scrollX+this.x>this.sheet.width-this.width||this.sheet.scrollY+this.y<20||this.sheet.scrollY+this.y>this.sheet.height-this.height?this.inputElement.hide():(this.inputElement.show(),this.inputElement.css("left",this.sheet.scrollX+this.x+"px"),this.inputElement.css("top",this.sheet.scrollY+this.y+"px"),this.inputElement.focus()))}blur(){this.isSelected=!1,this.isEditing&&(this.isEditing=!1,this.updateValue(this.inputElement.val()),this.inputElement.remove(),this.inputElement=void 0)}mouseDown(t,e){this.sheet.startMultiSelect(),this.sheet.updateSelection(this.rowIndex,this.index)}mouseMove(t,e){this.sheet.isMultiSelecting&&this.sheet.updateSelection(this.rowIndex,this.index)}mouseUp(t,e){1==this.sheet.multiSelectSize()&&(this.edit(),this.sheet.clearMultiSelect()),this.sheet.endMultiSelect()}mouseClick(t,e){}edit(){this.sheet.deselectAllCells(),this.isEditing=!0,this.inputElement=$("<input>",{type:"text",id:"cell-input",style:"text-align: "+(this.isNumeric?"right":"left")+";position: fixed;left: "+this.sheet.scrollX+this.x+"px;top: "+this.sheet.scrollY+this.y+"px;width: "+(this.width-4)+"px; height: "+(this.height-4)+"px;"}),$("body").append(this.inputElement);let t=!1;this.inputElement.val(this.value),this.inputElement.keydown(e=>{let s=e.keyCode||e.which;13===s?this.sheet.rows[this.rowIndex+(e.shiftKey?-1:1)].cells[this.index].edit():9===s?(this.sheet.rows[this.rowIndex].cells[this.index+(e.shiftKey?-1:1)].edit(),e.preventDefault()):37===s?t||this.sheet.rows[this.rowIndex].cells[this.index-1].edit():39===s?t||this.sheet.rows[this.rowIndex].cells[this.index+1].edit():38===s?this.sheet.rows[this.rowIndex-1].cells[this.index].edit():40===s?this.sheet.rows[this.rowIndex+1].cells[this.index].edit():46!==s&&8!==s||t||(this.inputElement.val(void 0),this.updateValue(void 0))}),this.inputElement.keyup(e=>{let s=e.keyCode||e.which;13!==s&&9!==s&&37!==s&&39!==s&&38!==s&&40!==s&&(t=!0,this.updateValue(this.inputElement.val()),this.isNumeric&&this.inputElement.css("text-align",this.isNumeric?"right":"left"))}),this.inputElement.bind("paste",t=>{t.originalEvent.clipboardData.getData("text")}),this.inputElement.focus()}};var x=class extends h{constructor(t,e,s,i,h,c){super(e,s,i,o+h*r,n),this.index=t,this.rowHeader=new l(0,t,e,0,this.y,o,n,{color:"black",backGroundColor:"lightGray",borderColor:"black",borderWidth:1}),this.cells=[];let d=o;for(let s=0;s<h;s++)this.cells.push(new u(s,t,e,d,this.y,r,n,c)),d+=r}draw(){for(let t=0;t<this.cells.length;t++){const e=this.cells[t];e.isVisibleOnScreen()&&e.draw()}this.rowHeader.draw()}resizeCol(t,e){let s=this.cells[t],i=s.width;s.width=e,s.repaint();for(let s=t+1;s<this.cells.length;s++)this.cells[s].x+=e-i}mouseDown(t,e){for(let s=0;s<this.cells.length;s++)this.cells[s].isCollision(t,e)&&this.cells[s].mouseDown(t,e)}mouseMove(t,e){for(let s=0;s<this.cells.length;s++)this.cells[s].isCollision(t,e)&&this.cells[s].mouseMove(t,e)}mouseUp(t,e){for(let s=0;s<this.cells.length;s++)this.cells[s].isCollision(t,e)&&this.cells[s].mouseUp(t,e)}mouseClick(t,e){for(let s=0;s<this.cells.length;s++)this.cells[s].isCollision(t,e)&&this.cells[s].mouseClick(t,e)}deselectAllCells(){for(let t=0;t<this.cells.length;t++)this.cells[t].blur()}updateSelection(t,e){for(let s=t;s<=e;s++)this.cells[s].isSelected=!0}getCell(t){return this.cells[t]}};var f=class extends h{constructor(t,e,s,i,h,l,o){super(e,s,i,h,l,o),this.index=t,Object.assign(this,{color:"black",backGroundColor:"lightGray",borderColor:"darkGray",borderWidth:1},o),this.updateText(d(this.index))}isVisibleOnScreen(){return!(this.x+this.sheet.scrollX+this.width<0||this.x+this.sheet.scrollX>this.sheet.width||this.y+this.height<0||this.y>this.sheet.height)}updateText(t){this.text=t,this.repaint()}repaint(){this.textBufferCanvas=document.createElement("canvas"),this.textBufferContext=this.textBufferCanvas.getContext("2d"),this.textBufferCanvas.width=2*this.width,this.textBufferCanvas.height=2*this.height,this.textBufferCanvas.style.width=this.width,this.textBufferCanvas.style.height=this.height,this.textBufferContext.scale(2,2),this.textBufferContext.font=.8*this.height+"px Sans",this.textBufferContext.fillStyle=this.color,this.textBufferContext.textAlign="center",this.textBufferContext.textBaseline="middle",this.textBufferContext.fillText(this.text,this.width/2,this.height/2)}draw(){this.sheet.context.drawRect(this.x+this.sheet.scrollX,this.y,this.width,this.height,{fillColor:this.backGroundColor,borderColor:this.borderColor,borderWidth:this.borderWidth}),this.sheet.context.drawImage(this.textBufferCanvas,this.x+this.sheet.scrollX,this.y,this.width,this.height)}};var w=class extends h{constructor(t,e,s,i,h){super(t,e,s,o+i*r,n),this.columnHeaders=[];let l=o;for(let e=0;e<i;e++)this.columnHeaders.push(new f(e,t,l,this.y,r,n,{color:"black",backGroundColor:"lightGray",borderColor:"black",borderWidth:1})),l+=r}draw(){for(let t=0;t<this.columnHeaders.length;t++){const e=this.columnHeaders[t];e.isVisibleOnScreen()&&e.draw()}}resizeCol(t,e){let s=this.columnHeaders[t],i=s.width;s.width=e,s.repaint();for(let s=t+1;s<this.columnHeaders.length;s++)this.columnHeaders[s].x+=e-i}mouseMove(t,e){if(this.isResizing){let e=t-this.resizeStartX;this.sheet.resizeCol(this.resizeHeader.index,this.resizeStartWidth+e)}else for(let e=0;e<this.columnHeaders.length;e++){let s=this.columnHeaders[e];t>s.x+this.sheet.scrollX+s.width-5&&t<s.x+this.sheet.scrollX+s.width+5&&(document.body.style.cursor="col-resize",this.resizeHeader=s)}}mouseDown(t,e){this.resizeHeader&&(this.resizeStartX=t,this.resizeStartWidth=this.resizeHeader.width,this.isResizing=!0)}mouseUp(t,e){this.resizeHeader=void 0,this.isResizing=!1}mouseClick(t,e){for(let s=0;s<this.columnHeaders.length;s++)this.columnHeaders[s].isCollision(t,e)&&this.columnHeaders[s].mouseClick(t,e)}};e.default={Sheet:class{constructor(t,e){this.scrollY=0,this.scrollX=0,this.selectMinRowIndex=-1,this.selectMaxRowIndex=-1,this.selectMinColIndex=-1,this.selectMaxColIndex=-1,Object.assign(this,{width:void 0,height:void 0,rowCount:2e3,colCount:200},e),this.context=new i(t,{onMouseMove:this.mouseMove.bind(this),onMouseDown:this.mouseDown.bind(this),onMouseUp:this.mouseUp.bind(this),onMouseClick:this.mouseClick.bind(this),onScroll:this.scroll.bind(this),width:this.width,height:this.height}),this.columnHeaderRow=new w(this,0,0,this.rowCount),this.rows=[];let s=n;for(let t=0;t<this.rowCount;t++)this.rows.push(new x(t,this,0,s,this.colCount)),s+=n;this.mainLoop()}mainLoop(){this.draw(),requestAnimationFrame(this.mainLoop.bind(this))}mouseDown(t,e){if(this.columnHeaderRow.isCollision(t,e))this.columnHeaderRow.mouseDown(t,e);else for(let s=0;s<this.rows.length;s++)this.rows[s].isCollision(t,e)&&this.rows[s].mouseDown(t,e)}mouseMove(t,e){if(document.body.style.cursor="default",this.columnHeaderRow.isCollision(t,e))this.columnHeaderRow.mouseMove(t,e);else for(let s=0;s<this.rows.length;s++)this.rows[s].isCollision(t,e)&&this.rows[s].mouseMove(t,e)}mouseUp(t,e){if(this.columnHeaderRow.isCollision(t,e))this.columnHeaderRow.mouseUp(t,e);else for(let s=0;s<this.rows.length;s++)this.rows[s].isCollision(t,e)&&this.rows[s].mouseUp(t,e)}mouseClick(t,e){for(let s=0;s<this.rows.length;s++)this.rows[s].isCollision(t,e)&&this.rows[s].mouseClick(t,e)}scroll(t,e){e>0?this.scrollY-=5*e:e<0&&this.scrollY<=-5*-e&&(this.scrollY-=5*e),t>0?this.scrollX-=5*t:t<0&&this.scrollX<=-5*-t&&(this.scrollX-=5*t)}draw(){this.context.drawRect(0,0,this.width,this.height,{borderColor:"darkGray",borderWidth:3,fillColor:"lightGray"});for(let t=0;t<this.rows.length;t++)this.rows[t].isVisibleOnScreen()&&this.rows[t].draw();if(this.columnHeaderRow.draw(),this.context.drawRect(0,0,o,n,{borderColor:"black",borderWidth:1,fillColor:"darkGray"}),this.showMultiSelect){let t=this.rows[this.selectMinRowIndex],e=(this.rows[this.selectMaxRowIndex],t.cells[this.selectMinColIndex].x+this.scrollX),s=t.y+this.scrollY,i=0;for(let e=this.selectMinColIndex;e<=this.selectMaxColIndex;e++)i+=t.cells[e].width;let h=0;for(let t=this.selectMinRowIndex;t<=this.selectMaxRowIndex;t++)h+=this.rows[t].height;this.context.drawRect(e,s,i,h,{borderColor:"blue",borderWidth:2})}}resizeRow(t,e){this.rows[t].height+=e;for(let s=t+1;s<this.rows.length;s++)this.rows[s].y+=e}resizeCol(t,e){if(!(e<0)){this.columnHeaderRow.resizeCol(t,e);for(let s=0;s<this.rows.length;s++)this.rows[s].resizeCol(t,e)}}deselectAllCells(){for(let t=0;t<this.rows.length;t++)this.rows[t].deselectAllCells()}startMultiSelect(){this.clearMultiSelect(),this.isMultiSelecting=!0,this.showMultiSelect=!0}endMultiSelect(){this.isMultiSelecting=!1}clearMultiSelect(){this.showMultiSelect=!1,this.selectMinRowIndex=-1,this.selectMaxRowIndex=-1,this.selectMinColIndex=-1,this.selectMaxColIndex=-1}multiSelectSize(){return(this.selectMaxRowIndex-this.selectMinRowIndex+1)*(this.selectMaxColIndex-this.selectMinColIndex+1)}updateSelection(t,e){if(this.isMultiSelecting){(-1==this.selectMinRowIndex||t<this.selectMinRowIndex)&&(this.selectMinRowIndex=t),(-1==this.selectMaxRowIndex||t>this.selectMaxRowIndex)&&(this.selectMaxRowIndex=t),(-1==this.selectMinColIndex||e<this.selectMinColIndex)&&(this.selectMinColIndex=e),(-1==this.selectMaxColIndex||e>this.selectMaxColIndex)&&(this.selectMaxColIndex=e),this.deselectAllCells();for(let t=this.selectMinRowIndex;t<=this.selectMaxRowIndex;t++)this.rows[t].updateSelection(this.selectMinColIndex,this.selectMaxColIndex)}}getCell(t,e){return this.rows[t].getCell(e)}}}}]);
//# sourceMappingURL=sheets.min.js.map